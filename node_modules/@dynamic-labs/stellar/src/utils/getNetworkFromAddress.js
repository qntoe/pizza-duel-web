'use client'
import { __awaiter } from '../../_virtual/_tslib.js';
import { Horizon, Networks } from '@stellar/stellar-sdk';

const HORIZON_MAINNET_URL = 'https://horizon.stellar.org';
const HORIZON_TESTNET_URL = 'https://horizon-testnet.stellar.org';
const getNetworkIdFromPassphrase = (passphrase) => __awaiter(void 0, void 0, void 0, function* () {
    const encoder = new TextEncoder();
    const data = encoder.encode(passphrase);
    const hashBuffer = yield crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');
});
/**
 * Checks if a Stellar account exists on a given Horizon server.
 *
 * @param address - The Stellar public key to check
 * @param server - The Horizon Server instance to query
 * @returns true if the account exists, false otherwise
 * @throws Re-throws non-404 errors (network errors, bad request, etc.)
 */
const accountExistsOnNetwork = (address, server) => __awaiter(void 0, void 0, void 0, function* () {
    var _a;
    try {
        yield server.loadAccount(address);
        return true;
    }
    catch (error) {
        // Account not found (404) - expected for unfunded accounts
        if (((_a = error === null || error === void 0 ? void 0 : error.response) === null || _a === void 0 ? void 0 : _a.status) === 404) {
            return false;
        }
        throw error;
    }
});
/**
 * Detects which Stellar network an address belongs to by checking
 * if the account exists on mainnet or testnet.
 *
 * @param address - The Stellar public key to check
 * @returns The network chainId (which is sha256 hash of the network passphrase)
 */
const getNetworkFromAddress = (address, defaultNetwork) => __awaiter(void 0, void 0, void 0, function* () {
    const mainnetServer = new Horizon.Server(HORIZON_MAINNET_URL);
    const testnetServer = new Horizon.Server(HORIZON_TESTNET_URL);
    // Check testnet
    const existsOnTestnet = yield accountExistsOnNetwork(address, testnetServer);
    if (existsOnTestnet) {
        return getNetworkIdFromPassphrase(Networks.TESTNET);
    }
    // Check mainnet first since it's the most common
    const existsOnMainnet = yield accountExistsOnNetwork(address, mainnetServer);
    if (existsOnMainnet) {
        return getNetworkIdFromPassphrase(Networks.PUBLIC);
    }
    // Account doesn't exist on either network (unfunded account)
    // Default to mainnet
    return defaultNetwork.chainId.toString();
});

export { getNetworkFromAddress, getNetworkIdFromPassphrase };
