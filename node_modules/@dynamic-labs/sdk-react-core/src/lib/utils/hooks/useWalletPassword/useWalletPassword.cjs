'use client'
'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var _tslib = require('../../../../../_virtual/_tslib.cjs');
var React = require('react');
var dynamicEvents = require('../../../events/dynamicEvents.cjs');
require('@dynamic-labs/iconic');
require('@dynamic-labs/wallet-connector-core');
require('react/jsx-runtime');
require('../../../context/ViewContext/ViewContext.cjs');
var logger = require('../../../shared/logger.cjs');
require('@dynamic-labs/wallet-book');
require('@dynamic-labs/utils');
require('../../constants/colors.cjs');
require('../../constants/values.cjs');
require('@dynamic-labs/sdk-api-core');
require('../../../shared/consts/index.cjs');
var useDynamicWaas = require('../useDynamicWaas/useDynamicWaas.cjs');

const INITIAL_STATE = {
    error: null,
    isLoading: false,
    recoveryState: null,
};
const useWalletPassword = () => {
    const { getWaasWalletConnector } = useDynamicWaas.useDynamicWaas();
    const [state, setState] = React.useState(INITIAL_STATE);
    const resetState = React.useCallback(() => {
        setState(INITIAL_STATE);
    }, []);
    const updatePassword = React.useCallback((params) => _tslib.__awaiter(void 0, void 0, void 0, function* () {
        const { accountAddress, chainName, newPassword, existingPassword } = params;
        setState((prev) => (Object.assign(Object.assign({}, prev), { error: null, isLoading: true })));
        try {
            const connector = getWaasWalletConnector(chainName);
            if (!connector) {
                const errorMessage = 'Wallet connector not found';
                setState((prev) => (Object.assign(Object.assign({}, prev), { error: errorMessage, isLoading: false })));
                logger.logger.error(errorMessage, { accountAddress, chainName });
                return false;
            }
            yield connector.updatePassword({
                accountAddress,
                existingPassword,
                newPassword,
            });
            setState((prev) => (Object.assign(Object.assign({}, prev), { error: null, isLoading: false })));
            return true;
        }
        catch (error) {
            const errorMessage = error instanceof Error ? error.message : 'Failed to update password';
            setState((prev) => (Object.assign(Object.assign({}, prev), { error: errorMessage, isLoading: false })));
            logger.logger.error('Failed to update wallet password', {
                accountAddress,
                chainName,
                error,
            });
            return false;
        }
    }), [getWaasWalletConnector]);
    const unlockWallet = React.useCallback((params) => _tslib.__awaiter(void 0, void 0, void 0, function* () {
        const { accountAddress, chainName, password } = params;
        setState((prev) => (Object.assign(Object.assign({}, prev), { error: null, isLoading: true })));
        try {
            const connector = getWaasWalletConnector(chainName);
            if (!connector) {
                const errorMessage = 'Wallet connector not found';
                setState((prev) => (Object.assign(Object.assign({}, prev), { error: errorMessage, isLoading: false })));
                logger.logger.error(errorMessage, { accountAddress, chainName });
                return false;
            }
            dynamicEvents.dynamicEvents.emit('walletUnlockAttempt', {
                accountAddress,
                chainName,
            });
            yield connector.unlockWallet({
                accountAddress,
                password,
            });
            setState((prev) => (Object.assign(Object.assign({}, prev), { error: null, isLoading: false })));
            dynamicEvents.dynamicEvents.emit('walletUnlockCompleted', {
                accountAddress,
                chainName,
            });
            return true;
        }
        catch (error) {
            const errorMessage = error instanceof Error ? error.message : 'Failed to unlock wallet';
            setState((prev) => (Object.assign(Object.assign({}, prev), { error: errorMessage, isLoading: false })));
            logger.logger.error('Failed to unlock wallet', {
                accountAddress,
                chainName,
                error,
            });
            dynamicEvents.dynamicEvents.emit('walletUnlockFailed', {
                accountAddress,
                chainName,
                error,
            });
            return false;
        }
    }), [getWaasWalletConnector]);
    const checkWalletLockState = React.useCallback((params) => _tslib.__awaiter(void 0, void 0, void 0, function* () {
        const { accountAddress, chainName } = params;
        setState((prev) => (Object.assign(Object.assign({}, prev), { error: null, isLoading: true })));
        try {
            const connector = getWaasWalletConnector(chainName);
            if (!connector) {
                const errorMessage = 'Wallet connector not found';
                setState((prev) => (Object.assign(Object.assign({}, prev), { error: errorMessage, isLoading: false })));
                logger.logger.error(errorMessage, { accountAddress, chainName });
                return null;
            }
            const recoveryState = yield connector.getWalletRecoveryState({
                accountAddress,
            });
            setState({
                error: null,
                isLoading: false,
                recoveryState,
            });
            return recoveryState;
        }
        catch (error) {
            const errorMessage = error instanceof Error
                ? error.message
                : 'Failed to check wallet state';
            setState({
                error: errorMessage,
                isLoading: false,
                recoveryState: null,
            });
            logger.logger.error('Failed to check wallet lock state', {
                accountAddress,
                chainName,
                error,
            });
            return null;
        }
    }), [getWaasWalletConnector]);
    return {
        checkWalletLockState,
        resetState,
        state,
        unlockWallet,
        updatePassword,
    };
};

exports.useWalletPassword = useWalletPassword;
